{% extends 'base.html' %}
{% load static %}

{% block title %}Quotation Items – Ruchaka Engineering{% endblock %}

{% block content %}

<div class="container py-2">

    <h6 class="mb-2 fw-semibold">Selected Items</h6>

    {% if cart_items %}
        <!-- Header Row -->
        <div class="row g-1 mb-1 fw-bold very-small text-center text-muted border-bottom pb-1">
            <div class="col-lg-2 col-md-2">Item</div>
            <div class="col-lg-3 col-md-3">Description</div>
            <div class="col-lg-1 col-md-1">Price</div>
            <div class="col-lg-1 col-md-1">Qty</div>
            <div class="col-lg-1 col-md-1">Total</div>
            <div class="col-lg-1 col-md-1">Lab/pc</div>
            <div class="col-lg-1 col-md-1">Tot Lab</div>
            <div class="col-lg-1 col-md-1">Subtotal</div>
            <div class="col-lg-1 col-md-1">Action</div>
        </div>

        {% for entry in cart_items %}
        <div class="row g-1 mb-2 align-items-center border-bottom pb-2 item-row very-small"
             data-item-id="{{ entry.item.id }}"
             data-price-q1="{{ entry.item.price_q1|default:0 }}"
             data-price-q2="{{ entry.item.price_q2|default:0 }}"
             data-price-q3="{{ entry.item.price_q3|default:0 }}">

            <!-- 1. Item -->
            <div class="col-lg-2 col-md-2 text-center">
                <div style="height: 45px; display: flex; align-items: center; justify-content: center;">
                    {% if entry.item.image %}
                        <img src="{{ entry.item.image.url }}" class="img-fluid rounded" 
                             alt="{{ entry.item.product_name }}" style="max-height: 45px; object-fit: contain;">
                    {% else %}
                        <i class="fa-solid fa-image text-muted" style="font-size: 1.1rem;"></i>
                    {% endif %}
                </div>
                <div class="fw-bold very-small text-truncate mt-1">{{ entry.item.product_name }}</div>
            </div>

            <!-- 2. Description -->
            <div class="col-lg-3 col-md-3">
                <div class="lh-1">
                    <div class="text-truncate"><strong>Cat:</strong> {{ entry.item.category.name|truncatewords:4 }}</div>
                    <div class="text-truncate"><strong>Co:</strong> {{ entry.item.company.name|truncatewords:3 }}</div>
                    <div class="text-muted text-truncate">
                        {{ entry.item.description|default:"-"|truncatewords:15 }}
                    </div>
                </div>
            </div>

            <!-- 3. Price -->
            <div class="col-lg-1 col-md-1 d-flex flex-column justify-content-center" style="height: 80px;">
                <div class="border rounded px-1 py-0 bg-success-subtle d-flex justify-content-between very-small mb-0">
                    Q1 <span>{{ entry.item.price_q1|default:"0" }}</span>
                </div>
                <div class="border rounded px-1 py-0 bg-warning-subtle d-flex justify-content-between very-small my-0">
                    Q2 <span>{{ entry.item.price_q2|default:"0" }}</span>
                </div>
                <div class="border rounded px-1 py-0 bg-danger-subtle d-flex justify-content-between very-small mt-0">
                    Q3 <span>{{ entry.item.price_q3|default:"0" }}</span>
                </div>
            </div>

            <!-- 4. Quantity -->
            <div class="col-lg-1 col-md-1">
                <form method="post" action="{% url 'update_cart_quantity' entry.item.id %}">
                    {% csrf_token %}
                    <div class="input-group input-group-sm">
                        <input type="number" name="quantity" value="{{ entry.quantity }}" min="1" 
                               class="form-control form-control-sm text-center qty-input" 
                               style="width: 38px; font-size: 0.75rem;" data-item-id="{{ entry.item.id }}">
                        <button type="submit" class="btn btn-outline-secondary btn-sm px-1 py-0">
                            <i class="fa-solid fa-check" style="font-size: 0.65rem;"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- 5. Total -->
            <div class="col-lg-1 col-md-1 d-flex flex-column justify-content-center" style="height: 80px;">
                <div class="border rounded px-1 py-0 bg-success-subtle d-flex justify-content-between very-small mb-0">
                    Q1 <strong><span class="total-value-q1">0</span></strong>
                </div>
                <div class="border rounded px-1 py-0 bg-warning-subtle d-flex justify-content-between very-small my-0">
                    Q2 <strong><span class="total-value-q2">0</span></strong>
                </div>
                <div class="border rounded px-1 py-0 bg-danger-subtle d-flex justify-content-between very-small mt-0">
                    Q3 <strong><span class="total-value-q3">0</span></strong>
                </div>
            </div>

            <!-- 6. Labour per piece -->
            <div class="col-lg-1 col-md-1 d-flex align-items-center justify-content-center">
                <input type="number" class="form-control form-control-sm labour-per-piece text-center" 
                       value="{{ entry.labour_per_piece|default:0 }}" min="0" step="1" 
                       style="width: 50px; font-size: 0.75rem;" data-item-id="{{ entry.item.id }}">
            </div>

            <!-- 7. Total Labour -->
            <div class="col-lg-1 col-md-1 d-flex align-items-center justify-content-center">
                <div class="border rounded px-1 py-0 bg-light text-center very-small w-100">
                    <strong><span class="total-labour">0</span></strong>
                </div>
            </div>

            <!-- 8. Subtotal -->
            <div class="col-lg-1 col-md-1 d-flex flex-column justify-content-center" style="height: 80px;">
                <div class="border rounded px-1 py-0 bg-success-subtle d-flex justify-content-between very-small mb-0">
                    Q1 <strong><span class="subtotal-q1">0</span></strong>
                </div>
                <div class="border rounded px-1 py-0 bg-warning-subtle d-flex justify-content-between very-small my-0">
                    Q2 <strong><span class="subtotal-q2">0</span></strong>
                </div>
                <div class="border rounded px-1 py-0 bg-danger-subtle d-flex justify-content-between very-small mt-0">
                    Q3 <strong><span class="subtotal-q3">0</span></strong>
                </div>
            </div>

            <!-- Delete / Remove Button – FIXED & VISIBLE -->
            <div class="col-lg-1 col-md-1 text-center align-self-center">
                <form method="post" action="{% url 'remove_from_cart' entry.item.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" title="Remove Item">
                        <i class="fa-solid fa-trash-can" style="font-size: 0.85rem;"></i>
                    </button>
                </form>
            </div>

        </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-3 text-muted very-small">
            <i class="fa-solid fa-cart-plus fa-lg mb-1 opacity-75"></i>
            <p class="mb-0">No items added yet</p>
        </div>
    {% endif %}

    <!-- Action buttons -->
    <div class="mt-3 d-flex gap-2 flex-wrap justify-content-center justify-content-md-start">
        <a href="{% url 'select_items' %}" class="btn btn-sm btn-outline-secondary px-2 py-1">
            <i class="fa-solid fa-plus me-1"></i>Add
        </a>
        <form method="post" action="{% url 'save_quotation' %}" class="m-0">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-primary px-2 py-1">
                <i class="fa-solid fa-floppy-disk me-1"></i>Save
            </button>
        </form>
        <a href="{% url 'generate_excel' %}" class="btn btn-sm btn-success px-2 py-1">
            <i class="fa-solid fa-file-excel me-1"></i>Excel
        </a>
    </div>

</div>

<style>
    .very-small { font-size: 0.70rem; line-height: 1.0; }
    .item-row .form-control-sm { 
        height: calc(1.35rem + 2px); 
        font-size: 0.72rem; 
        padding: 0.1rem 0.3rem; 
    }
    .item-row .btn-sm { 
        font-size: 0.65rem; 
        padding: 0.1rem 0.35rem; 
    }
    .border { border-color: #dee2e6 !important; }
    .item-row { 
        --bs-gutter-x: 0.2rem; 
    }
    /* Ensure single-line fit – no scroll */
    .container { overflow-x: hidden !important; max-width: 100%; }
    .row { flex-wrap: nowrap !important; }
</style>

<script>
// Your existing script (unchanged)
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.item-row').forEach(row => {
        const qtyInput        = row.querySelector('.qty-input');
        const labourPerPiece  = row.querySelector('.labour-per-piece');
        const totalLabourEl   = row.querySelector('.total-labour');

        const totals = {
            q1: row.querySelector('.total-value-q1'),
            q2: row.querySelector('.total-value-q2'),
            q3: row.querySelector('.total-value-q3')
        };

        const subtotals = {
            q1: row.querySelector('.subtotal-q1'),
            q2: row.querySelector('.subtotal-q2'),
            q3: row.querySelector('.subtotal-q3')
        };

        const p1 = parseFloat(row.dataset.priceQ1) || 0;
        const p2 = parseFloat(row.dataset.priceQ2) || 0;
        const p3 = parseFloat(row.dataset.priceQ3) || 0;

        function updateCalculations() {
            const qty         = parseFloat(qtyInput.value)      || 0;
            const labourPiece = parseFloat(labourPerPiece.value) || 0;

            const totalLabour = qty * labourPiece;
            totalLabourEl.textContent = totalLabour.toFixed(0);

            totals.q1.textContent    = (qty * p1).toFixed(0);
            totals.q2.textContent    = (qty * p2).toFixed(0);
            totals.q3.textContent    = (qty * p3).toFixed(0);

            subtotals.q1.textContent = ((qty * p1) + totalLabour).toFixed(0);
            subtotals.q2.textContent = ((qty * p2) + totalLabour).toFixed(0);
            subtotals.q3.textContent = ((qty * p3) + totalLabour).toFixed(0);
        }

        qtyInput.addEventListener('input', updateCalculations);
        labourPerPiece.addEventListener('input', updateCalculations);

        labourPerPiece.addEventListener('change', function() {
            const value = parseFloat(this.value) || 0;
            const itemId = this.dataset.itemId;

            clearTimeout(window.labourTimeout);
            window.labourTimeout = setTimeout(() => {
                fetch("{% url 'update_labour' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        labour_per_piece: value
                    })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'ok') {
                        labourPerPiece.style.borderColor = '#28a745';
                        setTimeout(() => labourPerPiece.style.borderColor = '', 1200);
                    }
                })
                .catch(err => console.error(err));
            }, 500);
        });

        updateCalculations();
    });
});
</script>

{% endblock %}