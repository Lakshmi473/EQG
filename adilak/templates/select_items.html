{% extends 'base.html' %}
{% load static %}

{% block title %}Select Items – Ruchaka Engineering{% endblock %}

{% block content %}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">

            <!-- Compact professional form -->
            <div class="bg-white shadow-sm border rounded-3 p-4">
                <h5 class="mb-4 fw-semibold text-center text-dark">
                    Add Product to Quotation
                </h5>

                <form id="item-selection-form" method="post" action="{% url 'add_item' %}">
                    {% csrf_token %}

                    <!-- Product Search -->
                    <div class="mb-3 position-relative">
                        <label for="product-input" class="form-label small fw-medium mb-1">Product Name</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-end-0"><i class="fa-solid fa-search small"></i></span>
                            <input 
                                type="text" 
                                class="form-control border-start-0" 
                                id="product-input" 
                                placeholder="Type product name..." 
                                autocomplete="off"
                            >
                        </div>
                        <input type="hidden" name="product_name" id="selected-product">
                        <div id="suggestions" class="suggestion-box shadow-sm"></div>
                    </div>

                    <!-- Category -->
                    <div class="mb-3">
                        <label for="category-select" class="form-label small fw-medium mb-1">Category</label>
                        <select class="form-select form-select-sm" id="category-select" name="category" disabled>
                            <option value="">— Select category —</option>
                        </select>
                    </div>

                    <!-- Company -->
                    <div class="mb-4">
                        <label for="company-select" class="form-label small fw-medium mb-1">Company / Brand</label>
                        <select class="form-select form-select-sm" id="company-select" name="company" disabled>
                            <option value="">— Select company —</option>
                        </select>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button 
                            type="submit" 
                            class="btn btn-success btn-sm fw-medium" 
                            id="add-btn" 
                            disabled
                        >
                            <i class="fa-solid fa-plus me-1"></i> Add to Quotation
                        </button>
                    </div>
                </form>
            </div>

            <!-- Cart Summary – with View button -->
            {% if cart_items %}
            <div class="mt-4 bg-white shadow-sm border rounded-3 p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0 fw-medium small">Current Quotation Items ({{ cart_items|length }})</h6>
                    <a href="{% url 'item_detail' cart_items.0.item.id %}" class="btn btn-sm btn-outline-success">
                     <i class="fa-solid fa-eye me-1"></i> View Details
                    </a>
                </div>

                <ul class="list-group list-group-flush small">
                    {% for entry in cart_items %}
                    <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-0 border-bottom">
                        <div>
                            <strong>{{ entry.item.product_name }}</strong>
                            <span class="text-muted ms-2">({{ entry.item.company.name }})</span>
                        </div>
                        <i class="fa-solid fa-check-circle text-success small"></i>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-center text-muted py-3 small">
                        No items added yet
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<style>
    /* Compact single-line styling */
    .form-control-sm,
    .form-select-sm {
        font-size: 0.875rem;
        height: calc(1.8rem + 2px);
        padding: 0.25rem 0.5rem;
    }

    .input-group-sm .form-control {
        height: calc(1.8rem + 2px);
    }

    .input-group-text {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
    }

    .btn-sm {
        font-size: 0.875rem;
        padding: 0.35rem 1rem;
    }

    .suggestion-box {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        margin-top: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        z-index: 1000;
        display: none;
    }

    .suggestion-item {
        padding: 0.45rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .suggestion-item:hover {
        background: #f8f9fa;
        color: var(--primary);
    }

    .bg-white.shadow-sm.border {
        border-color: #dee2e6 !important;
    }

    @media (max-width: 576px) {
        .container { padding-left: 1rem; padding-right: 1rem; }
        h5 { font-size: 1.25rem; }
    }
</style>

<script>
// Autocomplete + cascading logic (unchanged)
(function() {
    const productInput     = document.getElementById('product-input');
    const selectedProduct  = document.getElementById('selected-product');
    const suggestionsDiv   = document.getElementById('suggestions');
    const categorySelect   = document.getElementById('category-select');
    const companySelect    = document.getElementById('company-select');
    const addBtn           = document.getElementById('add-btn');

    let abortCtrl = null;
    let hideTimer = null;

    document.addEventListener('click', e => {
        if (!productInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });

    productInput.addEventListener('input', async function() {
        const q = this.value.trim();
        if (q.length < 2) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        if (abortCtrl) abortCtrl.abort();
        abortCtrl = new AbortController();

        try {
            const res = await fetch(`/api/products/?q=${encodeURIComponent(q)}`, { signal: abortCtrl.signal });
            if (!res.ok) throw new Error();
            const products = await res.json();
            renderSuggestions(products);
        } catch (err) {
            if (err.name !== 'AbortError') console.error(err);
        }
    });

    function renderSuggestions(products) {
        suggestionsDiv.innerHTML = '';
        if (!products?.length) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        products.forEach(name => {
            const div = document.createElement('div');
            div.className = 'suggestion-item';
            div.textContent = name;
            div.onclick = () => {
                productInput.value = name;
                selectedProduct.value = name;
                suggestionsDiv.style.display = 'none';
                loadCategories(name);
            };
            suggestionsDiv.appendChild(div);
        });
        suggestionsDiv.style.display = 'block';
    }

    async function loadCategories(product) {
        try {
            const res = await fetch(`/api/categories/?product=${encodeURIComponent(product)}`);
            const data = await res.json();
            categorySelect.innerHTML = '<option value="">— Select category —</option>';
            data.forEach(c => {
                const opt = new Option(c.name, c.id);
                categorySelect.add(opt);
            });
            categorySelect.disabled = false;
            companySelect.innerHTML = '<option value="">— Select company —</option>';
            companySelect.disabled = true;
            addBtn.disabled = true;
        } catch (err) {
            console.error(err);
        }
    }

    categorySelect.onchange = async function() {
        const catId = this.value;
        const prod = selectedProduct.value;
        if (!catId || !prod) {
            companySelect.innerHTML = '<option value="">— Select company —</option>';
            companySelect.disabled = true;
            addBtn.disabled = true;
            return;
        }

        try {
            const res = await fetch(`/api/companies/?product=${encodeURIComponent(prod)}&category=${catId}`);
            const data = await res.json();
            companySelect.innerHTML = '<option value="">— Select company —</option>';
            data.forEach(c => {
                const opt = new Option(c.name, c.id);
                companySelect.add(opt);
            });
            companySelect.disabled = false;
            addBtn.disabled = true;
        } catch (err) {
            console.error(err);
        }
    };

    companySelect.onchange = function() {
        addBtn.disabled = !(
            selectedProduct.value &&
            categorySelect.value &&
            companySelect.value
        );
    };

    productInput.onblur = () => {
        hideTimer = setTimeout(() => {
            if (productInput.value !== selectedProduct.value) {
                selectedProduct.value = '';
                categorySelect.disabled = true;
                categorySelect.innerHTML = '<option value="">— Select category —</option>';
                companySelect.disabled = true;
                companySelect.innerHTML = '<option value="">— Select company —</option>';
                addBtn.disabled = true;
            }
            suggestionsDiv.style.display = 'none';
        }, 200);
    };

    productInput.onfocus = () => {
        if (hideTimer) clearTimeout(hideTimer);
    };

    suggestionsDiv.onmousedown = e => e.preventDefault();
})();
</script>

{% endblock %}